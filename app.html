<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENFOCADOS - Entorno de Pruebas</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* Mantenemos tus estilos originales de producción */
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--Y:rgb(250,250,0);--Yd:rgb(215,215,0);--D:#2c3e50;--D2:#1a252f;--V:#10b981;--R:#ef4444;--G:#64748b;--B:#e2e8f0;--W:#f59e0b}
        body{font-family:'Inter',sans-serif;background:linear-gradient(160deg,#fffef0 0%,#fff9c4 100%);min-height:100vh;color:#1e293b}
        .wrap{max-width:860px;margin:0 auto;padding:1.8rem 1.2rem}
        header{text-align:center;margin-bottom:1.6rem}
        h1{font-family:'Montserrat',sans-serif;font-size:2.8rem;font-weight:800;color:var(--D)}
        .card{background:#fff;border-radius:18px;padding:2rem;box-shadow:0 4px 24px rgba(0,0,0,.08);border:2px solid var(--Y);margin-bottom:1.4rem}
        .field{margin-bottom:1.1rem}
        .field label{display:block;margin-bottom:.3rem;font-weight:600}
        .field input, .field select{width:100%;padding:.82rem;border:2px solid var(--B);border-radius:10px;font-size:1rem}
        .btn{width:100%;padding:.9rem;background:var(--Y);color:var(--D);border:none;border-radius:10px;font-size:1.05rem;font-weight:700;cursor:pointer;font-family:'Montserrat'}
        .btn:disabled{background:#cbd5e1;color:#94a3b8;cursor:not-allowed}
        .ubar{background:linear-gradient(135deg,var(--Y),rgb(255,255,100));padding:.78rem;border-radius:10px;display:flex;justify-content:space-between;margin-bottom:1.4rem;font-weight:600}
        .multi-box{border:2px solid var(--B);border-radius:10px;padding:10px;max-height:200px;overflow-y:auto;background:#f8fafc}
        .m-item{display:flex;align-items:center;padding:8px;gap:10px;border-bottom:1px solid #edf2f7}
        .pbar-bg{background:var(--B);border-radius:4px;height:6px;margin-bottom:1.2rem;overflow:hidden}
        .pbar{background:var(--Y);height:100%;transition:width .4s}
        .opt{display:flex;align-items:center;gap:.85rem;padding:1rem;border:2px solid var(--B);border-radius:11px;cursor:pointer;background:#fff;margin-bottom:10px}
        .opt.ok{border-color:var(--V);background:#f0fdf4}
        .opt.ko{border-color:var(--R);background:#fef2f2}
        .oltr{width:30px;height:30px;border-radius:50%;background:var(--B);display:flex;align-items:center;justify-content:center;font-weight:700}
        .fb{margin-top:1.3rem;padding:1.2rem;border-radius:10px;border-left:4px solid}
        .fb.ok{background:#f0fdf4;border-color:var(--V)}
        .fb.ko{background:#fef2f2;border-color:var(--R)}
        .hidden{display:none!important}
        .error-msg{color:var(--R); font-size: 0.85rem; margin-top: 5px; text-align: center; display: none;}
    </style>
</head>
<body>

<div class="wrap">
    <header>
        <h1>ENFOCADOS</h1>
        <div style="color:var(--G); font-weight: 500;">ENTORNO DE PRUEBAS</div>
    </header>

    <div id="secLogin" class="card">
        <h2 style="text-align:center;margin-bottom:1.5rem">Acceso Alumnos Activos</h2>
        <div class="field"><label>Email</label><input type="email" id="inEmail" placeholder="tu@email.com"></div>
        <button id="btnLogin" class="btn" onclick="doLogin()">Entrar</button>
        <div id="loginError" class="error-msg"></div>
    </div>

    <div id="secConfig" class="card hidden">
        <div class="ubar"><span id="cfgUser"></span><span style="cursor:pointer" onclick="location.reload()">SALIR</span></div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px">
            <div class="field"><label>Nº Preguntas</label><input type="number" id="inNum" value="10" min="5"></div>
            <div class="field"><label>Feedback</label><select id="inFeedback"><option value="con">Con explicación</option><option value="sin">Sin explicación</option></select></div>
        </div>
        <div class="field">
            <label>Materias Disponibles</label>
            <div id="multiMat" class="multi-box"></div>
        </div>
        <button id="btnStart" class="btn" onclick="startExam()">Empezar Test</button>
    </div>

    <div id="secQ" class="card hidden">
        <div class="pbar-bg"><div id="pBar" class="pbar"></div></div>
        <div id="qTxt" style="font-size:1.1rem;font-weight:600;margin-bottom:1.5rem"></div>
        <div id="optsWrap"></div>
        <div id="fbWrap"></div>
        <div style="display:flex; gap:10px; margin-top:1.5rem">
            <button class="btn" style="background:var(--B)" onclick="prevQ()">Anterior</button>
            <button id="btnNext" class="btn" onclick="nextQ()">Siguiente</button>
        </div>
    </div>

    <div id="secRes" class="card hidden" style="text-align:center">
        <h2>Resultado</h2>
        <div id="rPct" style="font-size:4rem;font-weight:800;margin:1rem 0"></div>
        <div id="resButtons" style="display:flex; flex-direction:column; gap:10px"></div>
    </div>
</div>

<script>
// ESTA ES TU API ESPEJO DE PRUEBAS
const API_URL = 'https://script.google.com/macros/s/AKfycbw9MQnIJS-S0TEvukVEeHPAm11lKca1-c6BuT4V7ZqMr1X93m7P7Q5izKlXiSyrdHIz/exec';

let allQuestions = [], exam = [], idx = 0, userAnswers = [], isReviewing = false;
let questionsWithMistakes = [], showInstantFeedback = true;

// Motor de conexión adaptado para GitHub (JSONP)
function callAPI(type) {
    return new Promise((resolve, reject) => {
        const callbackName = 'jsonp_' + Math.round(Math.random() * 1000000);
        const script = document.createElement('script');
        script.id = callbackName;
        window[callbackName] = (data) => {
            delete window[callbackName];
            document.getElementById(callbackName).remove();
            resolve(data);
        };
        script.src = `${API_URL}?type=${type}&callback=${callbackName}&t=${Date.now()}`;
        script.onerror = () => reject(new Error("Error de red o API bloqueada"));
        document.head.appendChild(script);
        setTimeout(() => { if(window[callbackName]) reject(new Error("La base de datos no responde")); }, 20000);
    });
}

async function doLogin() {
    const email = document.getElementById('inEmail').value.trim().toLowerCase();
    const btn = document.getElementById('btnLogin');
    const err = document.getElementById('loginError');
    if(!email) return;

    btn.disabled = true; btn.innerText = "Verificando acceso..."; err.style.display = 'none';

    try {
        // 1. Verificamos en la hoja de 'usuarios activos' (API Espejo)
        const resU = await callAPI('users');
        
        // Mapeo flexible de columnas (no importa si es CORREO o Email)
        const headers = resU.headers.map(h => h.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, ''));
        const users = resU.rows.map(row => {
            let obj = {}; headers.forEach((h, i) => obj[h] = row[i]);
            return obj;
        });

        const user = users.find(u => (u.correo || u.email || "").toString().toLowerCase() === email);

        if(!user) throw new Error("Acceso denegado: Email no está en la lista de activos.");

        // 2. Si es válido, cargamos la base de datos de preguntas
        const resQ = await callAPI('questions');
        const qHeaders = resQ.headers.map(h => h.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, ''));
        allQuestions = resQ.rows.map(row => {
            let obj = {}; qHeaders.forEach((h, i) => obj[h] = row[i]);
            return obj;
        });

        document.getElementById('cfgUser').innerText = (user.usuario || "ALUMNO").toUpperCase();
        setupMats();
        showScreen('secConfig');

    } catch (e) {
        err.innerText = e.message; err.style.display = 'block';
        btn.disabled = false; btn.innerText = "Entrar";
    }
}

function setupMats() {
    const mats = [...new Set(allQuestions.map(q => q.materia).filter(m => m))].sort();
    const cont = document.getElementById('multiMat');
    cont.innerHTML = "";
    mats.forEach(m => {
        cont.innerHTML += `<label class="m-item"><input type="checkbox" name="mat" value="${m}" checked> ${m}</label>`;
    });
}

function showScreen(id) {
    document.querySelectorAll('.card').forEach(c => c.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    window.scrollTo(0,0);
}

function startExam() {
    let num = parseInt(document.getElementById('inNum').value) || 10;
    showInstantFeedback = document.getElementById('inFeedback').value === "con";
    const sel = Array.from(document.querySelectorAll('input[name="mat"]:checked')).map(c => c.value);
    let pool = allQuestions.filter(q => sel.includes(q.materia));
    if(!pool.length) return alert("Selecciona materias");
    exam = pool.sort(() => 0.5 - Math.random()).slice(0, num);
    idx = 0; userAnswers = new Array(exam.length).fill(null);
    isReviewing = false;
    showQ(); showScreen('secQ');
}

function showQ() {
    const q = exam[idx]; const ans = userAnswers[idx];
    document.getElementById('pBar').style.width = ((idx + 1) / exam.length * 100) + "%";
    document.getElementById('qTxt').innerText = q.pregunta;
    const wrap = document.getElementById('optsWrap');
    wrap.innerHTML = ""; document.getElementById('fbWrap').innerHTML = "";
    
    const letras = ['A','B','C','D'];
    const correcta = (q.respuesta||"").toString().trim().toUpperCase();
    const opciones = (q.opciones||"").split('\n').filter(o => o.trim());

    opciones.forEach((txt, i) => {
        const L = letras[i];
        const d = document.createElement('div');
        d.className = 'opt';
        if(ans && (showInstantFeedback || isReviewing)) {
            if(L === correcta) d.className = 'opt ok';
            else if(L === ans) d.className = 'opt ko';
        } else if(ans === L) d.style.borderColor = "var(--D)";
        
        d.innerHTML = `<div class="oltr">${L}</div><div style="flex:1">${txt}</div>`;
        d.onclick = () => { if(!ans || (!showInstantFeedback && !isReviewing)) { userAnswers[idx] = L; showQ(); } };
        wrap.appendChild(d);
    });

    if(ans && (showInstantFeedback || isReviewing)) {
        const ok = ans === correcta;
        document.getElementById('fbWrap').innerHTML = `<div class="fb ${ok?'ok':'ko'}"><b>${ok?'CORRECTO':'INCORRECTO'}</b><br>${q.saber || q.explicacion || 'Respuesta: '+correcta}</div>`;
    }
}

function nextQ() { if(idx < exam.length-1) { idx++; showQ(); } else { finish(); } }
function prevQ() { if(idx > 0) { idx--; showQ(); } }

function finish() {
    let oks = 0;
    exam.forEach((q, i) => { if(userAnswers[i] === (q.respuesta||"").toString().trim().toUpperCase()) oks++; });
    document.getElementById('rPct').innerText = Math.round(oks/exam.length*100) + "%";
    document.getElementById('resButtons').innerHTML = `<button class="btn" onclick="location.reload()">Nuevo Test</button>`;
    showScreen('secRes');
}
</script>
</body>
</html>
