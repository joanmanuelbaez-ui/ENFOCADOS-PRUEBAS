<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENFOCADOS PRUEBAS</title>
    <style>
        body { font-family: sans-serif; background: #fff9c4; text-align: center; padding: 50px; }
        .box { background: white; padding: 30px; border-radius: 20px; border: 3px solid #facc15; max-width: 400px; margin: auto; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 15px; background: #facc15; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
        .error { color: red; margin-top: 10px; font-size: 0.8rem; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="box">
    <h1>ENFOCADOS</h1>
    <p>Entorno de Pruebas</p>

    <div id="loginArea">
        <input type="email" id="uEmail" placeholder="Introduce tu email">
        <button id="btn" onclick="iniciarLogin()">ENTRAR AL SISTEMA</button>
        <p id="msg"></p>
    </div>

    <div id="configArea" class="hidden">
        <h2 style="color:green">¡Acceso Correcto!</h2>
        <p>Cargando materias...</p>
        <div id="listaMaterias" style="text-align:left; background:#f0f0f0; padding:10px; border-radius:5px"></div>
    </div>
</div>

<script>
// URL limpia del script
const URL_SCRIPT = 'https://script.google.com/macros/s/AKfycbwzQPNahJxw8YTLln-O9WaAkXoH3Vd0h7sFgugRxHX8bIEfasezvzl6ZvEENiTJMWKF/exec';

function iniciarLogin() {
    const email = document.getElementById('uEmail').value.trim().toLowerCase();
    const msg = document.getElementById('msg');
    const btn = document.getElementById('btn');

    if(!email) { alert("Escribe un email"); return; }

    btn.disabled = true;
    btn.innerText = "VERIFICANDO...";
    msg.innerText = "Conectando con Google Sheets...";

    // Llamada JSONP
    const script = document.createElement('script');
    const callbackName = 'callback_' + Math.round(Math.random() * 10000);
    
    window[callbackName] = function(data) {
        delete window[callbackName];
        document.body.removeChild(script);
        procesarRespuesta(data, email);
    };

    script.src = URL_SCRIPT + '?type=users&callback=' + callbackName + '&t=' + Date.now();
    script.onerror = () => {
        msg.innerHTML = '<b class="error">Error de red: El Script de Google no responde.</b>';
        btn.disabled = false;
        btn.innerText = "REINTENTAR";
    };
    document.body.appendChild(script);
}

function procesarRespuesta(res, email) {
    const msg = document.getElementById('msg');
    const btn = document.getElementById('btn');
    
    // Buscar email en la columna 'correo' (asumiendo que es la segunda columna o tiene ese encabezado)
    const headers = res.headers.map(h => h.toLowerCase().trim());
    const emailIdx = headers.indexOf('correo');
    
    const usuario = res.rows.find(r => r[emailIdx] && r[emailIdx].toLowerCase().trim() === email);

    if(usuario) {
        msg.innerText = "Usuario validado. Trayendo preguntas...";
        cargarPreguntas();
    } else {
        msg.innerHTML = '<b class="error">Email no encontrado en la base de datos de pruebas.</b>';
        btn.disabled = false;
        btn.innerText = "ENTRAR";
    }
}

function cargarPreguntas() {
    const scriptQ = document.createElement('script');
    const cbQ = 'cbQ_' + Math.round(Math.random() * 10000);
    
    window[cbQ] = function(data) {
        const materias = [...new Set(data.rows.map(r => r[3]))]; // Asumiendo que materia es col 4
        document.getElementById('loginArea').classList.add('hidden');
        document.getElementById('configArea').classList.remove('hidden');
        
        const lista = document.getElementById('listaMaterias');
        materias.forEach(m => { if(m) lista.innerHTML += '<div>• ' + m + '</div>'; });
    };

    scriptQ.src = URL_SCRIPT + '?type=questions&callback=' + cbQ;
    document.body.appendChild(scriptQ);
}
</script>

</body>
</html>
